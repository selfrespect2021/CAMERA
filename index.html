<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA Face Scanner - Version Finale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .scanning::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: #6366f1; box-shadow: 0 0 15px #6366f1;
            animation: scan 3s linear infinite;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 min-h-screen p-4">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-slate-800/50 p-6 rounded-[2rem] border border-slate-700">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-3 rounded-2xl">
                    <i data-lucide="shield-check" class="w-8 h-8 text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tight">FACE ID <span class="text-indigo-500">PRO</span></h1>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Système de présence autonome</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4 bg-slate-900/50 p-2 rounded-2xl">
                <button onclick="switchTab('scan')" id="btn-scan" class="px-6 py-2 rounded-xl text-sm font-bold bg-indigo-600 text-white transition-all">Scanner</button>
                <button onclick="switchTab('admin')" id="btn-admin" class="px-6 py-2 rounded-xl text-sm font-bold text-slate-400 hover:bg-slate-800 transition-all">Administration</button>
            </div>
        </header>

        <div id="loader" class="fixed inset-0 z-[200] bg-slate-900 flex flex-col items-center justify-center">
            <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p id="loader-text" class="font-bold text-indigo-400 animate-pulse text-center px-4">
                Connexion aux modèles IA en cours...<br>
                <span class="text-xs font-normal text-slate-500">(Autorisez la caméra si demandé)</span>
            </p>
        </div>

        <div id="tab-scan" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 relative">
                <div class="relative aspect-video bg-black rounded-[2.5rem] overflow-hidden border-4 border-slate-800 scanning shadow-2xl">
                    <video id="video" autoplay playsinline muted class="w-full h-full object-cover"></video>
                    <canvas id="overlay" class="absolute inset-0 w-full h-full"></canvas>
                    
                    <div id="notif" class="hidden absolute bottom-10 left-1/2 -translate-x-1/2 bg-emerald-500 text-white px-8 py-4 rounded-2xl font-black shadow-2xl flex items-center gap-3 animate-bounce">
                        <i data-lucide="user-check"></i> <span id="notif-name">NOM</span>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800/50 p-6 rounded-[2rem] border border-slate-700">
                <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest mb-4">Derniers passages</h3>
                <div id="mini-log" class="space-y-3"></div>
            </div>
        </div>

        <div id="tab-admin" class="hidden space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white text-slate-900 p-8 rounded-[2.5rem]">
                    <h2 class="text-2xl font-black mb-6">Ajouter un élève</h2>
                    <input type="text" id="new-name" placeholder="Nom de l'élève" class="w-full px-6 py-4 rounded-2xl bg-slate-100 mb-4 font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                    
                    <div class="relative aspect-video bg-slate-200 rounded-2xl overflow-hidden mb-6">
                        <canvas id="capture-canvas" class="w-full h-full object-cover hidden"></canvas>
                        <div id="capture-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                            <i data-lucide="camera" class="w-12 h-12 opacity-20"></i>
                            <p class="text-xs font-bold uppercase mt-2">Appuyez sur capturer</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="takeSnapshot()" class="bg-slate-800 text-white py-4 rounded-2xl font-black">CAPTURER</button>
                        <button onclick="registerStudent()" class="bg-indigo-600 text-white py-4 rounded-2xl font-black">ENREGISTRER</button>
                    </div>
                </div>

                <div class="bg-slate-800/50 p-8 rounded-[2.5rem] border border-slate-700">
                    <h2 class="text-2xl font-black mb-6 text-white">Base de données</h2>
                    <div id="admin-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let labeledDescriptors = [];
        let attendance = [];

        // INITIALISATION AVEC LIEN DE SECOURS
      async function initIA() {
    // Ce lien est un miroir officiel de confiance qui contourne les blocages GitHub
    const URL = 'https://raw.githubusercontent.com/vladmandic/face-api/master/model/';
    
    try {
        console.log("Démarrage du chargement des modèles...");
        await faceapi.nets.ssdMobilenetv1.loadFromUri(URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(URL);
        
        console.log("Modèles IA chargés !");
        
        // Chargement des données locales
        const saved = localStorage.getItem('face_data');
        if (saved) {
            const parsed = JSON.parse(saved);
            labeledDescriptors = parsed.map(d => new faceapi.LabeledFaceDescriptors(
                d.label, 
                [new Float32Array(Object.values(d.descriptors[0]))]
            ));
        }

        startCamera();
    } catch (e) {
        console.error("Erreur détaillée :", e);
        document.getElementById('loader-text').innerHTML = 
            "<span class='text-red-500'>L'IA n'arrive pas à télécharger les modèles.<br>Essayez d'actualiser la page (F5).</span>";
    }
}

        async function startCamera() {
            try {
                const video = document.getElementById('video');
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                document.getElementById('loader').classList.add('hidden');
                lucide.createIcons();
            } catch (e) {
                alert("Erreur : La caméra est bloquée ou non détectée.");
            }
        }

        // CAPTURE ET ENREGISTREMENT
        function takeSnapshot() {
            const canvas = document.getElementById('capture-canvas');
            const video = document.getElementById('video');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            canvas.classList.remove('hidden');
            document.getElementById('capture-placeholder').classList.add('hidden');
        }

        async function registerStudent() {
            const name = document.getElementById('new-name').value;
            const canvas = document.getElementById('capture-canvas');
            if(!name || canvas.classList.contains('hidden')) return alert("Nom + Capture requis");

            const detection = await faceapi.detectSingleFace(canvas).withFaceLandmarks().withFaceDescriptor();
            if(!detection) return alert("IA : Visage non détecté !");

            labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]));
            localStorage.setItem('face_data', JSON.stringify(labeledDescriptors));
            
            alert(`${name} enregistré avec succès !`);
            document.getElementById('new-name').value = '';
            canvas.classList.add('hidden');
            updateLists();
        }

        // BOUCLE DE RECONNAISSANCE
        const video = document.getElementById('video');
        video.addEventListener('play', () => {
            const overlay = document.getElementById('overlay');
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(overlay, displaySize);

            setInterval(async () => {
                if(labeledDescriptors.length === 0) return;

                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resized = faceapi.resizeResults(detections, displaySize);
                const matcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
                
                const ctx = overlay.getContext('2d');
                ctx.clearRect(0, 0, overlay.width, overlay.height);

                resized.forEach((d, i) => {
                    const result = matcher.findBestMatch(d.descriptor);
                    const box = d.detection.box;
                    
                    ctx.strokeStyle = result.label !== 'unknown' ? '#10b981' : '#ef4444';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);

                    if(result.label !== 'unknown') markAttendance(result.label);
                });
            }, 1000);
        });

        function markAttendance(name) {
            const date = new Date().toLocaleDateString();
            if(!attendance.find(a => a.name === name && a.date === date)) {
                attendance.push({ name, date, time: new Date().toLocaleTimeString() });
                document.getElementById('notif-name').innerText = name;
                document.getElementById('notif').classList.remove('hidden');
                setTimeout(() => document.getElementById('notif').classList.add('hidden'), 3000);
                updateLists();
            }
        }

        function updateLists() {
            document.getElementById('admin-list').innerHTML = labeledDescriptors.map(d => `
                <div class="flex justify-between bg-slate-700/50 p-3 rounded-xl">
                    <span class="font-bold text-sm">${d.label}</span>
                </div>`).join('');

            document.getElementById('mini-log').innerHTML = attendance.slice(-5).reverse().map(a => `
                <div class="bg-slate-900/50 p-3 rounded-xl border-l-4 border-indigo-500 text-xs">
                    <b>${a.name}</b> - ${a.time}
                </div>`).join('');
        }

        function switchTab(tab) {
            document.getElementById('tab-scan').classList.toggle('hidden', tab !== 'scan');
            document.getElementById('tab-admin').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('btn-scan').className = tab === 'scan' ? 'px-6 py-2 rounded-xl text-sm font-bold bg-indigo-600 text-white' : 'px-6 py-2 rounded-xl text-sm font-bold text-slate-400';
            document.getElementById('btn-admin').className = tab === 'admin' ? 'px-6 py-2 rounded-xl text-sm font-bold bg-indigo-600 text-white' : 'px-6 py-2 rounded-xl text-sm font-bold text-slate-400';
        }

        initIA();
    </script>
</body>
</html>
